# Sky Takeout 阿里云部署说明

## 🚀 快速部署

### 前提条件

1. **阿里云ECS服务器**
   - 已购买并运行中的ECS实例
   - 操作系统: CentOS 7+ 或 Ubuntu 18.04+
   - 内存: 至少2GB RAM
   - 硬盘: 至少20GB可用空间

2. **本地环境**
   - 已安装Java 8+和Maven 3.6+
   - 可以SSH连接到阿里云服务器
   - 已获取服务器IP地址和root密码

3. **网络配置**
   - 服务器可以访问互联网（用于下载软件包）
   - 本地可以SSH连接到服务器

### 部署步骤

#### 方法一：一键部署（推荐）

```bash
# 1. 给脚本执行权限
chmod +x deploy_to_aliyun.sh

# 2. 运行部署脚本
./deploy_to_aliyun.sh

# 或者直接指定服务器IP
./deploy_to_aliyun.sh 你的服务器IP
```

#### 方法二：手动部署

1. **本地打包项目**
   ```bash
   mvn clean package -DskipTests
   ```

2. **上传到服务器**
   ```bash
   scp -r ./* root@服务器IP:/opt/sky-takeout/
   ```

3. **在服务器上安装环境**
   ```bash
   ssh root@服务器IP
   cd /opt/sky-takeout
   chmod +x quick_deploy.sh
   ./quick_deploy.sh
   ```

4. **配置数据库**
   ```bash
   chmod +x deploy_database.sh
   ./deploy_database.sh
   ```

5. **启动应用**
   ```bash
   systemctl start sky-takeout
   systemctl enable sky-takeout
   ```

### 配置说明

#### 数据库配置
- **数据库名**: `happy_tassie_travel`
- **用户名**: `skyapp`
- **默认密码**: `Sky2024@Strong!` (建议修改)

#### 应用配置
- **端口**: 8080
- **环境**: production
- **日志路径**: `/opt/sky-takeout/logs/`

#### Redis配置
- **端口**: 6379
- **数据库**: 0

### 阿里云安全组配置

在阿里云控制台配置安全组规则：

1. 登录阿里云控制台
2. 进入ECS管理页面
3. 选择你的实例，点击"安全组配置"
4. 添加入方向规则：
   - 端口范围: 8080/8080
   - 协议类型: TCP
   - 授权对象: 0.0.0.0/0
   - 描述: Sky Takeout应用端口

### 验证部署

部署完成后，通过以下方式验证：

1. **检查服务状态**
   ```bash
   ssh root@服务器IP 'systemctl status sky-takeout'
   ```

2. **查看应用日志**
   ```bash
   ssh root@服务器IP 'journalctl -u sky-takeout -f'
   ```

3. **访问应用**
   - 应用首页: `http://服务器IP:8080`
   - API文档: `http://服务器IP:8080/doc.html`

4. **测试数据库连接**
   ```bash
   ssh root@服务器IP 'mysql -u skyapp -pSky2024@Strong! happy_tassie_travel -e "SHOW TABLES;"'
   ```

### 常见问题

#### 1. 服务启动失败
```bash
# 查看详细错误信息
journalctl -u sky-takeout --no-pager

# 检查Java版本
java -version

# 检查JAR文件是否存在
ls -la /opt/sky-takeout/sky-take-out/sky-server/target/
```

#### 2. 数据库连接失败
```bash
# 检查MySQL服务状态
systemctl status mysqld

# 测试数据库连接
mysql -u skyapp -p happy_tassie_travel

# 检查数据库用户权限
mysql -u root -p -e "SELECT user, host FROM mysql.user WHERE user = 'skyapp';"
```

#### 3. 端口访问问题
```bash
# 检查应用是否监听8080端口
netstat -tlnp | grep 8080

# 检查防火墙状态
systemctl status firewalld
firewall-cmd --list-ports

# 检查阿里云安全组配置
```

#### 4. Redis连接失败
```bash
# 检查Redis服务状态
systemctl status redis

# 测试Redis连接
redis-cli ping

# 检查Redis配置
cat /etc/redis/redis.conf | grep bind
```

### 运维管理

#### 启动/停止/重启服务
```bash
# 启动
systemctl start sky-takeout

# 停止
systemctl stop sky-takeout

# 重启
systemctl restart sky-takeout

# 查看状态
systemctl status sky-takeout
```

#### 查看日志
```bash
# 实时查看日志
journalctl -u sky-takeout -f

# 查看最近100行日志
journalctl -u sky-takeout -n 100

# 查看应用日志文件
tail -f /opt/sky-takeout/logs/sky-takeout.log
```

#### 数据库备份
```bash
# 手动备份
/opt/scripts/backup_database.sh

# 设置定时备份（每天凌晨2点）
crontab -e
# 添加: 0 2 * * * /opt/scripts/backup_database.sh
```

#### 更新应用
```bash
# 1. 本地重新打包
mvn clean package -DskipTests

# 2. 上传新的JAR文件
scp sky-server/target/sky-server-1.0-SNAPSHOT.jar root@服务器IP:/opt/sky-takeout/sky-take-out/sky-server/target/

# 3. 重启服务
ssh root@服务器IP 'systemctl restart sky-takeout'
```

### 安全建议

1. **修改默认密码**
   - 数据库密码
   - 应用JWT密钥

2. **限制数据库访问**
   ```sql
   -- 只允许本地访问MySQL
   DELETE FROM mysql.user WHERE user='skyapp' AND host='%';
   FLUSH PRIVILEGES;
   ```

3. **配置HTTPS**
   - 申请SSL证书
   - 配置Nginx反向代理

4. **定期备份**
   - 设置自动数据库备份
   - 备份应用配置文件

### 联系支持

如果遇到部署问题，请提供以下信息：
- 服务器操作系统版本
- 错误日志内容
- 服务状态信息
- 网络配置详情

---

**祝你部署成功！🎉** 