# 阿里云香港服务器部署指南

## 1. 服务器环境准备

### 1.1 连接服务器
```bash
# 使用SSH连接到阿里云服务器
ssh root@你的服务器IP
```

### 1.2 更新系统
```bash
# CentOS/RHEL
yum update -y

# Ubuntu/Debian  
apt update && apt upgrade -y
```

## 2. 安装Java环境

### 2.1 安装OpenJDK 8/11
```bash
# CentOS/RHEL
yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel

# Ubuntu/Debian
apt install -y openjdk-8-jdk

# 验证安装
java -version
javac -version
```

### 2.2 配置JAVA_HOME
```bash
# 编辑环境变量
vim /etc/profile

# 添加以下内容
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
export PATH=$PATH:$JAVA_HOME/bin

# 重新加载配置
source /etc/profile
```

## 3. 安装MySQL数据库

### 3.1 安装MySQL 8.0
```bash
# CentOS/RHEL
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
rpm -ivh mysql80-community-release-el7-3.noarch.rpm
yum install -y mysql-server

# Ubuntu/Debian
apt install -y mysql-server
```

### 3.2 启动和配置MySQL
```bash
# 启动MySQL服务
systemctl start mysqld
systemctl enable mysqld

# 查看临时密码（CentOS）
grep 'temporary password' /var/log/mysqld.log

# 安全配置
mysql_secure_installation
```

### 3.3 创建数据库和用户
```sql
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE happy_tassie_travel CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建应用用户
CREATE USER 'skyapp'@'%' IDENTIFIED BY 'YourStrongPassword123!';
GRANT ALL PRIVILEGES ON happy_tassie_travel.* TO 'skyapp'@'%';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

## 4. 安装Maven

### 4.1 下载和安装Maven
```bash
cd /opt
wget https://downloads.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz
tar -xzf apache-maven-3.8.6-bin.tar.gz
mv apache-maven-3.8.6 maven

# 配置环境变量
vim /etc/profile

# 添加Maven路径
export MAVEN_HOME=/opt/maven
export PATH=$PATH:$MAVEN_HOME/bin

# 重新加载
source /etc/profile

# 验证安装
mvn -version
```

## 5. 部署应用程序

### 5.1 创建应用目录
```bash
mkdir -p /opt/sky-takeout
cd /opt/sky-takeout
```

### 5.2 上传代码
```bash
# 方法1: 使用scp从本地上传
scp -r ./sky-take-out root@服务器IP:/opt/sky-takeout/

# 方法2: 使用git clone
git clone https://github.com/your-repo/sky-take-out.git
```

### 5.3 配置数据库连接
```bash
cd /opt/sky-takeout/sky-take-out/sky-server/src/main/resources
vim application.yml
```

更新数据库配置：
```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/happy_tassie_travel?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true
    username: skyapp
    password: YourStrongPassword123!
```

### 5.4 导入数据库结构
```bash
# 导入数据库结构和数据
mysql -u skyapp -p happy_tassie_travel < database_schema.sql
mysql -u skyapp -p happy_tassie_travel < database_data.sql
```

### 5.5 编译和打包
```bash
cd /opt/sky-takeout/sky-take-out
mvn clean package -DskipTests
```

## 6. 配置系统服务

### 6.1 创建systemd服务文件
```bash
vim /etc/systemd/system/sky-takeout.service
```

添加以下内容：
```ini
[Unit]
Description=Sky Takeout Application
After=mysql.service
Requires=mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/sky-takeout/sky-take-out
ExecStart=/usr/bin/java -jar sky-server/target/sky-server-1.0-SNAPSHOT.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 6.2 启动服务
```bash
# 重新加载systemd
systemctl daemon-reload

# 启动服务
systemctl start sky-takeout
systemctl enable sky-takeout

# 查看状态
systemctl status sky-takeout

# 查看日志
journalctl -u sky-takeout -f
```

## 7. 配置防火墙和安全组

### 7.1 开放必要端口
```bash
# CentOS/RHEL (firewalld)
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --reload

# Ubuntu/Debian (ufw)
ufw allow 8080/tcp
ufw allow 3306/tcp
ufw enable
```

### 7.2 阿里云安全组配置
1. 登录阿里云控制台
2. 进入ECS实例管理
3. 配置安全组规则：
   - 添加规则：端口8080，协议TCP，授权对象0.0.0.0/0
   - 添加规则：端口3306，协议TCP，授权对象0.0.0.0/0（生产环境建议限制IP）

## 8. 安装Nginx（可选）

### 8.1 安装Nginx
```bash
# CentOS/RHEL
yum install -y nginx

# Ubuntu/Debian
apt install -y nginx
```

### 8.2 配置反向代理
```bash
vim /etc/nginx/sites-available/sky-takeout
```

添加配置：
```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用配置：
```bash
ln -s /etc/nginx/sites-available/sky-takeout /etc/nginx/sites-enabled/
systemctl restart nginx
systemctl enable nginx
```

## 9. 监控和日志

### 9.1 应用监控
```bash
# 查看应用状态
systemctl status sky-takeout

# 查看实时日志
tail -f /var/log/sky-takeout.log

# 查看系统资源
top
free -h
df -h
```

### 9.2 设置日志轮转
```bash
vim /etc/logrotate.d/sky-takeout
```

添加：
```
/var/log/sky-takeout.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

## 10. 备份策略

### 10.1 数据库备份脚本
```bash
vim /opt/scripts/backup_database.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups"
mkdir -p $BACKUP_DIR

mysqldump -u skyapp -pYourStrongPassword123! happy_tassie_travel > $BACKUP_DIR/happy_tassie_travel_$DATE.sql
gzip $BACKUP_DIR/happy_tassie_travel_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

### 10.2 设置定时备份
```bash
chmod +x /opt/scripts/backup_database.sh
crontab -e

# 添加每天凌晨2点备份
0 2 * * * /opt/scripts/backup_database.sh
```

## 11. 测试部署

### 11.1 验证服务
```bash
# 检查应用是否启动
curl http://localhost:8080/health

# 检查数据库连接
mysql -u skyapp -p -e "SELECT 1"

# 检查端口监听
netstat -tlnp | grep :8080
```

### 11.2 访问测试
- 浏览器访问: http://服务器IP:8080
- API测试: http://服务器IP:8080/api/test

## 故障排查

### 常见问题
1. **端口被占用**: `lsof -i :8080`
2. **内存不足**: `free -h`, 考虑添加swap
3. **磁盘空间**: `df -h`
4. **数据库连接**: 检查用户权限和防火墙
5. **应用日志**: `journalctl -u sky-takeout -f`

### 性能优化
1. **JVM参数调优**:
   ```bash
   ExecStart=/usr/bin/java -Xms512m -Xmx1024m -jar sky-server/target/sky-server-1.0-SNAPSHOT.jar
   ```

2. **数据库优化**:
   ```sql
   # 在/etc/mysql/mysql.conf.d/mysqld.cnf中添加
   innodb_buffer_pool_size = 256M
   query_cache_size = 64M
   ```

## 总结

部署完成后，你的应用将在阿里云香港服务器上运行，通过以下方式访问：
- 直接访问: http://服务器IP:8080
- 通过Nginx: http://服务器IP

记得定期更新系统和应用，监控服务状态，并保持数据备份！ 