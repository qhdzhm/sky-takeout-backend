# AI产品匹配优化说明

## 问题描述
中介端AI填订单信息时，有时候找不到产品。例如：
- 用户输入："塔塔斯马尼亚3日游"
- 数据库产品名："南部3日游（霍巴特-亚瑟港-布鲁尼）"
- 无法匹配成功

## 解决方案

### 1. AI智能选择（终极方案）

当关键词匹配都失败时，让AI自己根据订单描述和所有可用产品列表，智能选择最合适的产品。

**工作流程：**
1. 获取所有活跃的产品列表（只有9个产品）
2. 将产品列表和用户输入发送给AI
3. AI分析天数、地区、目的地等因素
4. AI返回最匹配的产品ID

**优势：**
- 即使产品名完全不匹配，AI也能理解订单意图
- 适应性强，可以处理各种不规范的输入
- 产品数量少，AI选择速度快且准确

**示例：**
```
输入："塔塔斯马尼亚3日游"
AI分析：用户想要3天的行程
产品列表中3天的只有：南部3日游（霍巴特-亚瑟港-布鲁尼）
AI返回：26
匹配成功！
```

### 2. 优化关键词提取逻辑 (ChatBotServiceImpl.extractKeywords)

**改进内容：**
- 支持识别打字错误（如"塔塔"识别为"塔斯马尼亚"）
- 使用正则表达式提取天数关键词（支持"3日"、"3天"等多种格式）
- 添加更多目的地关键词（霍巴特、朗塞、布鲁尼、亚瑟港、酒杯湾等）
- 添加产品特色关键词（精品、小团等）
- 如果无法提取关键词，直接使用清理后的产品名进行模糊搜索

**关键代码：**
```java
// 使用正则表达式提取数字天数
Pattern dayPattern = Pattern.compile("(\\d+)\\s*(?:日|天)");
Matcher dayMatcher = dayPattern.matcher(originalLower);
if (dayMatcher.find()) {
    String dayNum = dayMatcher.group(1);
    keywords.add(dayNum + "日");
}
```

### 3. 优化产品匹配逻辑 (ChatBotServiceImpl.findMatchingProduct)

**四层匹配策略（由严格到宽松）：**
1. **完全匹配**：尝试用产品名或产品代码(tour_code)完全匹配
2. **关键词匹配**：提取多个关键词进行智能匹配
3. **天数匹配**：如果前两步失败，仅使用天数关键词进行宽松匹配
4. **AI智能选择**：让AI根据订单描述从所有产品中选择最合适的（新增！）

**匹配示例：**
- 输入："塔塔斯马尼亚3日游" 或 "塔斯马尼亚3日游"
- 提取关键词：["3日"]
- 数据库搜索：WHERE title LIKE '%3日%'
- 匹配成功："南部3日游（霍巴特-亚瑟港-布鲁尼）"

### 3. 数据库查询优化

已有的Mapper方法支持：
- `findByNameLike(String name)`: 模糊匹配产品名称或产品代码
- `findByKeywords(String[] keywords)`: 多关键词智能搜索，按匹配度排序
- `findAllActive()`: 获取所有活跃产品作为备选

## 测试案例

### 案例1：天数匹配（关键词匹配）
- **输入**："塔塔斯马尼亚3日游"
- **提取关键词**：["3日"]
- **匹配方式**：关键词匹配
- **预期匹配**："南部3日游（霍巴特-亚瑟港-布鲁尼）"

### 案例2：目的地+天数匹配（关键词匹配）
- **输入**："霍巴特4日游"
- **提取关键词**：["霍巴特", "4日"]
- **匹配方式**：关键词匹配
- **预期匹配**："南部4日游（霍巴特-布鲁尼-亚瑟港-酒杯湾）" 或其他包含霍巴特和4日的产品

### 案例3：南北线匹配（关键词匹配）
- **输入**："南北5日游"
- **提取关键词**：["南北", "5日"]
- **匹配方式**：关键词匹配
- **预期匹配**："南北5日游（霍巴特-布鲁尼-酒杯湾-摇篮山-朗赛）"

### 案例4：完全不规范的输入（AI智能选择）
- **输入**："塔塔三天的团"
- **提取关键词**：[]（无法提取有效关键词）
- **匹配方式**：AI智能选择
- **AI分析**：用户想要3天的团
- **产品列表**：将所有9个产品提供给AI
- **AI选择**：26（南部3日游）
- **预期匹配**："南部3日游（霍巴特-亚瑟港-布鲁尼）"

### 案例5：模糊描述（AI智能选择）
- **输入**："想去看酒杯湾和摇篮山，5天左右"
- **提取关键词**：["酒杯湾", "摇篮山", "5日"]
- **第一次匹配**：可能匹配到多个5日游产品
- **如果不够精确**：AI会根据"酒杯湾"和"摇篮山"选择包含这两个景点的南北线路
- **预期匹配**：南北5日游相关产品

## 日志输出

### 关键词匹配成功的日志：
```
开始智能产品匹配，输入服务类型: 塔塔斯马尼亚3日游
提取到天数关键词: 3日
使用关键词进行匹配: [3日]
关键词匹配成功: 南部3日游（霍巴特-亚瑟港-布鲁尼） (ID: 26), 共找到 1 个相似产品
```

### AI智能选择的日志：
```
开始智能产品匹配，输入服务类型: 塔塔三天的团
未能提取到有效关键词
前面的匹配方法都失败，尝试使用AI智能选择产品
发送AI智能选择请求，产品数量: 9
AI成功选择产品: 南部3日游（霍巴特-亚瑟港-布鲁尼） (ID: 26)
AI智能选择成功: 南部3日游（霍巴特-亚瑟港-布鲁尼） (ID: 26)
```

## 使用方法

1. 中介用户在聊天窗口发送订单信息
2. AI自动识别为订单数据
3. 系统提取关键词并匹配产品
4. 成功匹配后自动跳转到订单页面并预填信息

## 注意事项

- 确保group_tours表中产品的title字段包含关键信息（如天数、目的地）
- 如果完全找不到匹配，系统会返回相似产品列表供用户选择
- tour_code字段（团号）现在是可选的，主要依赖产品名称进行匹配

## 文件修改清单

- ✅ `ChatBotServiceImpl.java` - 优化关键词提取和产品匹配逻辑
- ✅ `GroupTourMapper.java` - 已有模糊搜索方法（无需修改）
- ✅ `GroupTourMapper.xml` - 已有SQL查询（无需修改）

## 未来优化建议

1. 可以考虑使用AI进行更智能的产品名称相似度匹配
2. 添加产品别名表，支持多个产品名称指向同一产品
3. 使用搜索引擎（如Elasticsearch）提升搜索性能和准确度

