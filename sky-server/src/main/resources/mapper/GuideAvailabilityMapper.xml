<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.GuideAvailabilityMapper">

    <!-- 结果映射 -->
    <resultMap id="GuideAvailabilityVOMap" type="com.sky.vo.GuideAvailabilityVO">
        <result column="guide_id" property="guideId"/>
        <result column="date" property="date"/>
        <result column="available_start_time" property="availableStartTime"/>
        <result column="available_end_time" property="availableEndTime"/>
        <result column="status" property="status"/>
        <result column="max_groups" property="maxGroups"/>
        <result column="current_groups" property="currentGroups"/>
        <result column="notes" property="notes"/>
    </resultMap>

    <!-- 获取导游可用性列表 -->
    <select id="getGuideAvailability" resultMap="GuideAvailabilityVOMap">
        SELECT 
            ga.guide_id,
            ga.date as date,
            ga.available_start_time,
            ga.available_end_time,
            ga.status,
            ga.max_groups,
            COALESCE(assigned_count.current_groups, 0) as current_groups,
            ga.notes
        FROM guide_availability ga
        LEFT JOIN (
            SELECT 
                guide_id,
                assignment_date,
                COUNT(*) as current_groups
            FROM guide_daily_assignment 
            WHERE assignment_status IN ('confirmed', 'in_progress')
            GROUP BY guide_id, assignment_date
        ) assigned_count ON ga.guide_id = assigned_count.guide_id 
                         AND ga.date = assigned_count.assignment_date
        WHERE ga.guide_id = #{guideId}
        AND ga.date BETWEEN #{startDate} AND #{endDate}
        ORDER BY ga.date ASC
    </select>

    <!-- 根据日期获取导游可用性 -->
    <select id="getGuideAvailabilityByDate" resultMap="GuideAvailabilityVOMap">
        SELECT 
            ga.guide_id,
            ga.date as date,
            ga.available_start_time,
            ga.available_end_time,
            ga.status,
            ga.max_groups,
            COALESCE(assigned_count.current_groups, 0) as current_groups,
            ga.notes
        FROM guide_availability ga
        LEFT JOIN (
            SELECT 
                guide_id,
                assignment_date,
                COUNT(*) as current_groups
            FROM guide_daily_assignment 
            WHERE assignment_status IN ('confirmed', 'in_progress')
            GROUP BY guide_id, assignment_date
        ) assigned_count ON ga.guide_id = assigned_count.guide_id 
                         AND ga.date = assigned_count.assignment_date
        WHERE ga.guide_id = #{guideId}
        AND ga.date = #{date}
    </select>

    <!-- 插入导游可用性 -->
    <insert id="insertGuideAvailability">
        INSERT INTO guide_availability (
            guide_id, 
            date, 
            available_start_time, 
            available_end_time, 
            status, 
            max_groups, 
            notes,
            created_time,
            updated_time
        ) VALUES (
            #{guideId}, 
            #{date}, 
            #{availableStartTime}, 
            #{availableEndTime}, 
            #{status}, 
            #{maxGroups}, 
            #{notes},
            NOW(),
            NOW()
        )
    </insert>

    <!-- 更新导游可用性 -->
    <update id="updateGuideAvailability">
        UPDATE guide_availability 
        SET 
            available_start_time = #{availableStartTime},
            available_end_time = #{availableEndTime},
            status = #{status},
            max_groups = #{maxGroups},
            notes = #{notes},
            updated_time = NOW()
        WHERE guide_id = #{guideId} 
        AND date = #{date}
    </update>

    <!-- 删除导游可用性 -->
    <delete id="deleteGuideAvailability">
        DELETE FROM guide_availability 
        WHERE guide_id = #{guideId} 
        AND date = #{date}
    </delete>

</mapper> 