<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.VehicleMapper">

    <!-- 分页查询车辆 -->
    <select id="pageQuery" resultType="com.sky.entity.Vehicle">
        SELECT v.vehicle_id,
               v.vehicle_type,
               v.license_plate,
               v.acn,
               v.maker,
               v.model,
               v.year,
               v.rego_expiry_date,
               v.inspection_due_date,
               v.notes,
               v.max_drivers,
               v.location,
               v.seat_count,
               v.create_time,
               v.update_time,
               v.fuel_level,
               v.current_location,
               -- 动态计算状态：先检查手动设置的送修状态，再检查过期情况
               CASE 
                   WHEN v.status = 0 THEN 0  -- 送修中状态保持不变
                   WHEN v.status = 2 THEN 2  -- 维修中状态保持不变  
                   WHEN v.status = 3 THEN 3  -- 停用状态保持不变
                   WHEN v.rego_expiry_date IS NOT NULL AND v.rego_expiry_date &lt; CURDATE() THEN 4  -- 注册过期
                   WHEN v.inspection_due_date IS NOT NULL AND v.inspection_due_date &lt; CURDATE() THEN 5  -- 车检过期
                   ELSE 1  -- 可用
               END AS status,
               COALESCE(GROUP_CONCAT(DISTINCT e.name ORDER BY e.name SEPARATOR ', '), '') AS driverName
        FROM vehicles v
        LEFT JOIN vehicle_driver vd ON v.vehicle_id = vd.vehicle_id AND vd.is_primary = 1
        LEFT JOIN employees e ON vd.employee_id = e.id
        <where>
            <if test="vehicleType != null and vehicleType != ''">
                AND v.vehicle_type LIKE CONCAT('%', #{vehicleType}, '%')
            </if>
            <if test="licensePlate != null and licensePlate != ''">
                AND v.license_plate LIKE CONCAT('%', #{licensePlate}, '%')
            </if>
            <if test="acn != null and acn != ''">
                AND v.acn LIKE CONCAT('%', #{acn}, '%')
            </if>
            <if test="maker != null and maker != ''">
                AND v.maker LIKE CONCAT('%', #{maker}, '%')
            </if>
            <if test="model != null and model != ''">
                AND v.model LIKE CONCAT('%', #{model}, '%')
            </if>
            <if test="year != null">
                AND v.year = #{year}
            </if>
            <if test="location != null and location != ''">
                AND v.location LIKE CONCAT('%', #{location}, '%')
            </if>
            <if test="seatCount != null">
                AND v.seat_count = #{seatCount}
            </if>
            <if test="regoExpiryDate != null">
                AND v.rego_expiry_date = #{regoExpiryDate}
            </if>
            <if test="inspectionDueDate != null">
                AND v.inspection_due_date = #{inspectionDueDate}
            </if>
            <!-- 状态过滤：使用计算后的状态进行过滤 -->
            <if test="status != null">
                AND (
                    CASE 
                        WHEN v.status = 0 THEN 0
                        WHEN v.status = 2 THEN 2
                        WHEN v.status = 3 THEN 3
                        WHEN v.rego_expiry_date IS NOT NULL AND v.rego_expiry_date &lt; CURDATE() THEN 4
                        WHEN v.inspection_due_date IS NOT NULL AND v.inspection_due_date &lt; CURDATE() THEN 5
                        ELSE 1
                    END
                ) = #{status}
            </if>
            <!-- 如果需要按司机名称过滤，使用子查询 -->
            <if test="driverName != null and driverName != ''">
                AND EXISTS (
                    SELECT 1 FROM vehicle_driver vd2 
                    LEFT JOIN employees e2 ON vd2.employee_id = e2.id 
                    WHERE vd2.vehicle_id = v.vehicle_id 
                    AND e2.name LIKE CONCAT('%', #{driverName}, '%')
                )
            </if>
        </where>
        GROUP BY v.vehicle_id, v.vehicle_type, v.license_plate, v.acn, v.maker, v.model, v.year,
                 v.rego_expiry_date, v.inspection_due_date, v.status, v.notes, v.max_drivers, v.location, 
                 v.seat_count, v.create_time, v.update_time, v.fuel_level, v.current_location
        ORDER BY v.vehicle_id
    </select>

</mapper>