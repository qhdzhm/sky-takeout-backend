<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.TicketBookingMapper">

    <!-- ç»“æžœæ˜ å°„ -->
    <resultMap id="BaseResultMap" type="com.sky.entity.TicketBooking">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="booking_reference" property="bookingReference" jdbcType="VARCHAR"/>
        <result column="confirmation_number" property="confirmationNumber" jdbcType="VARCHAR"/>
        <result column="schedule_order_id" property="scheduleOrderId" jdbcType="BIGINT"/>
        <result column="tour_booking_id" property="tourBookingId" jdbcType="BIGINT"/>
        <result column="assignment_id" property="assignmentId" jdbcType="BIGINT"/>
        <result column="attraction_id" property="attractionId" jdbcType="BIGINT"/>
        <result column="ticket_type_id" property="ticketTypeId" jdbcType="BIGINT"/>
        <result column="guest_name" property="guestName" jdbcType="VARCHAR"/>
        <result column="guest_phone" property="guestPhone" jdbcType="VARCHAR"/>
        <result column="guest_email" property="guestEmail" jdbcType="VARCHAR"/>
        <result column="visit_date" property="visitDate" jdbcType="DATE"/>
        <result column="booking_date" property="bookingDate" jdbcType="DATE"/>
        <result column="adult_count" property="adultCount" jdbcType="INTEGER"/>
        <result column="child_count" property="childCount" jdbcType="INTEGER"/>
        <result column="total_guests" property="totalGuests" jdbcType="INTEGER"/>
        <result column="ticket_price" property="ticketPrice" jdbcType="DECIMAL"/>
        <result column="total_amount" property="totalAmount" jdbcType="DECIMAL"/>
        <result column="currency" property="currency" jdbcType="VARCHAR"/>
        <result column="booking_method" property="bookingMethod" jdbcType="VARCHAR"/>
        <result column="booking_status" property="bookingStatus" jdbcType="VARCHAR"/>
        <result column="payment_status" property="paymentStatus" jdbcType="VARCHAR"/>
        <result column="special_requirements" property="specialRequirements" jdbcType="VARCHAR"/>
        <result column="booking_source" property="bookingSource" jdbcType="VARCHAR"/>
        <result column="booked_by" property="bookedBy" jdbcType="BIGINT"/>
        <result column="ticket_specialist" property="ticketSpecialist" jdbcType="VARCHAR"/>
        <result column="notes" property="notes" jdbcType="VARCHAR"/>
        <result column="email_sent_time" property="emailSentTime" jdbcType="TIMESTAMP"/>
        <result column="confirmed_time" property="confirmedTime" jdbcType="TIMESTAMP"/>
        <result column="visited_time" property="visitedTime" jdbcType="TIMESTAMP"/>
        <result column="cancelled_time" property="cancelledTime" jdbcType="TIMESTAMP"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <!-- æ–°å¢žæ‰¹é‡è®¢ç¥¨ç›¸å…³å­—æ®µæ˜ å°„ -->
        <result column="related_order_ids" property="relatedOrderIds" jdbcType="VARCHAR"/>
        <result column="related_order_numbers" property="relatedOrderNumbers" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- åŸºç¡€åˆ— -->
    <sql id="Base_Column_List">
        id, booking_reference, confirmation_number, schedule_order_id, tour_booking_id, assignment_id,
        attraction_id, ticket_type_id, guest_name, guest_phone, guest_email, visit_date, booking_date,
        adult_count, child_count, total_guests, ticket_price, total_amount, currency,
        booking_method, booking_status, payment_status, special_requirements, booking_source,
        booked_by, ticket_specialist, notes, email_sent_time, confirmed_time, visited_time,
        cancelled_time, created_at, updated_at, related_order_ids, related_order_numbers
    </sql>

    <!-- æ’å…¥ç¥¨åŠ¡é¢„è®¢ -->
    <insert id="insert" parameterType="com.sky.entity.TicketBooking" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ticket_bookings (
            booking_reference, confirmation_number, schedule_order_id, tour_booking_id, assignment_id,
            attraction_id, ticket_type_id, guest_name, guest_phone, guest_email, visit_date, booking_date,
            adult_count, child_count, total_guests, ticket_price, total_amount, currency,
            booking_method, booking_status, payment_status, special_requirements, booking_source,
            booked_by, ticket_specialist, notes, email_sent_time, confirmed_time, visited_time,
            cancelled_time, created_at, updated_at, related_order_ids, related_order_numbers
        ) VALUES (
            #{bookingReference}, #{confirmationNumber}, #{scheduleOrderId}, #{tourBookingId}, #{assignmentId},
            #{attractionId}, #{ticketTypeId}, #{guestName}, #{guestPhone}, #{guestEmail}, #{visitDate}, #{bookingDate},
            #{adultCount}, #{childCount}, #{totalGuests}, #{ticketPrice}, #{totalAmount}, #{currency},
            #{bookingMethod}, #{bookingStatus}, #{paymentStatus}, #{specialRequirements}, #{bookingSource},
            #{bookedBy}, #{ticketSpecialist}, #{notes}, #{emailSentTime}, #{confirmedTime}, #{visitedTime},
            #{cancelledTime}, #{createdAt}, #{updatedAt}, #{relatedOrderIds}, #{relatedOrderNumbers}
        )
    </insert>

    <!-- æ ¹æ®IDæŸ¥è¯¢ç¥¨åŠ¡é¢„è®¢ -->
    <select id="getById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE id = #{id}
    </select>

    <!-- æ ¹æ®é¢„è®¢å‚è€ƒå·æŸ¥è¯¢ -->
    <select id="getByBookingReference" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE booking_reference = #{bookingReference}
    </select>

    <!-- æ ¹æ®ç¡®è®¤å·æŸ¥è¯¢ -->
    <select id="getByConfirmationNumber" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE confirmation_number = #{confirmationNumber}
    </select>

    <!-- æ ¹æ®æŽ’å›¢è®°å½•IDæŸ¥è¯¢ -->
    <select id="getByScheduleOrderId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE schedule_order_id = #{scheduleOrderId}
    </select>

    <!-- æ ¹æ®æ—…æ¸¸è®¢å•IDæŸ¥è¯¢ -->
    <!-- ðŸ†• æ”¯æŒæ‰¹é‡è®¢ç¥¨ï¼šåŒæ—¶æŸ¥è¯¢ tour_booking_id å’Œ related_order_ids -->
    <select id="getByTourBookingId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE tour_booking_id = #{tourBookingId}
           OR (related_order_ids IS NOT NULL 
               AND JSON_CONTAINS(related_order_ids, CAST(#{tourBookingId} AS JSON), '$'))
        ORDER BY visit_date ASC
    </select>

    <!-- æ›´æ–°ç¥¨åŠ¡é¢„è®¢ -->
    <update id="update" parameterType="com.sky.entity.TicketBooking">
        UPDATE ticket_bookings 
        SET booking_reference = #{bookingReference},
            confirmation_number = #{confirmationNumber},
            schedule_order_id = #{scheduleOrderId},
            tour_booking_id = #{tourBookingId},
            assignment_id = #{assignmentId},
            attraction_id = #{attractionId},
            ticket_type_id = #{ticketTypeId},
            guest_name = #{guestName},
            guest_phone = #{guestPhone},
            guest_email = #{guestEmail},
            visit_date = #{visitDate},
            booking_date = #{bookingDate},
            adult_count = #{adultCount},
            child_count = #{childCount},
            total_guests = #{totalGuests},
            ticket_price = #{ticketPrice},
            total_amount = #{totalAmount},
            currency = #{currency},
            booking_method = #{bookingMethod},
            booking_status = #{bookingStatus},
            payment_status = #{paymentStatus},
            special_requirements = #{specialRequirements},
            booking_source = #{bookingSource},
            booked_by = #{bookedBy},
            ticket_specialist = #{ticketSpecialist},
            notes = #{notes},
            email_sent_time = #{emailSentTime},
            confirmed_time = #{confirmedTime},
            visited_time = #{visitedTime},
            cancelled_time = #{cancelledTime},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <!-- åˆ é™¤ç¥¨åŠ¡é¢„è®¢ -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM ticket_bookings WHERE id = #{id}
    </delete>

    <!-- æ‰¹é‡åˆ é™¤ç¥¨åŠ¡é¢„è®¢ -->
    <delete id="batchDelete" parameterType="java.util.List">
        DELETE FROM ticket_bookings 
        WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- æ›´æ–°é¢„è®¢çŠ¶æ€ -->
    <update id="updateStatus">
        UPDATE ticket_bookings 
        SET booking_status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- æ‰¹é‡æ›´æ–°é¢„è®¢çŠ¶æ€ -->
    <update id="batchUpdateStatus">
        UPDATE ticket_bookings 
        SET booking_status = #{status}, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- æ›´æ–°ç¡®è®¤å· -->
    <update id="updateConfirmationNumber">
        UPDATE ticket_bookings 
        SET confirmation_number = #{confirmationNumber}, 
            confirmed_time = #{confirmedTime},
            booking_status = 'confirmed',
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- æ›´æ–°é‚®ä»¶å‘é€æ—¶é—´ -->
    <update id="updateEmailSentTime">
        UPDATE ticket_bookings 
        SET email_sent_time = #{emailSentTime},
            booking_status = 'email_sent',
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- åˆ†é¡µæŸ¥è¯¢ç¥¨åŠ¡é¢„è®¢ -->
    <select id="pageQuery" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        <where>
            <if test="guestName != null and guestName != ''">
                AND guest_name LIKE CONCAT('%', #{guestName}, '%')
            </if>
            <if test="guestPhone != null and guestPhone != ''">
                AND guest_phone LIKE CONCAT('%', #{guestPhone}, '%')
            </if>
            <if test="attractionId != null">
                AND attraction_id = #{attractionId}
            </if>
            <if test="bookingStatus != null and bookingStatus != ''">
                AND booking_status = #{bookingStatus}
            </if>
            <if test="bookingMethod != null and bookingMethod != ''">
                AND booking_method = #{bookingMethod}
            </if>
            <if test="visitDateStart != null">
                AND visit_date &gt;= #{visitDateStart}
            </if>
            <if test="visitDateEnd != null">
                AND visit_date &lt;= #{visitDateEnd}
            </if>
            <if test="ticketSpecialist != null and ticketSpecialist != ''">
                AND ticket_specialist = #{ticketSpecialist}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- ç»Ÿè®¡æŸ¥è¯¢æ€»æ•° -->
    <select id="countQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM ticket_bookings 
        <where>
            <if test="guestName != null and guestName != ''">
                AND guest_name LIKE CONCAT('%', #{guestName}, '%')
            </if>
            <if test="guestPhone != null and guestPhone != ''">
                AND guest_phone LIKE CONCAT('%', #{guestPhone}, '%')
            </if>
            <if test="attractionId != null">
                AND attraction_id = #{attractionId}
            </if>
            <if test="bookingStatus != null and bookingStatus != ''">
                AND booking_status = #{bookingStatus}
            </if>
            <if test="bookingMethod != null and bookingMethod != ''">
                AND booking_method = #{bookingMethod}
            </if>
            <if test="visitDateStart != null">
                AND visit_date &gt;= #{visitDateStart}
            </if>
            <if test="visitDateEnd != null">
                AND visit_date &lt;= #{visitDateEnd}
            </if>
            <if test="ticketSpecialist != null and ticketSpecialist != ''">
                AND ticket_specialist = #{ticketSpecialist}
            </if>
        </where>
    </select>

    <!-- æ ¹æ®æ™¯ç‚¹IDå’Œæ¸¸è§ˆæ—¥æœŸæŸ¥è¯¢é¢„è®¢ -->
    <select id="getByAttractionAndDate" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE attraction_id = #{attractionId} AND visit_date = #{visitDate}
        ORDER BY booking_status, created_at ASC
    </select>

    <!-- æ ¹æ®æ¸¸è§ˆæ—¥æœŸèŒƒå›´æŸ¥è¯¢é¢„è®¢ -->
    <select id="getByVisitDateRange" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE visit_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY visit_date, attraction_id
    </select>

    <!-- ç»Ÿè®¡é¢„è®¢çŠ¶æ€ -->
    <select id="getStatusStatistics" resultType="java.util.Map">
        SELECT 
            booking_status as status,
            COUNT(*) as count,
            SUM(total_amount) as totalAmount
        FROM ticket_bookings 
        <where>
            <if test="attractionId != null">
                AND attraction_id = #{attractionId}
            </if>
            <if test="startDate != null">
                AND visit_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND visit_date &lt;= #{endDate}
            </if>
        </where>
        GROUP BY booking_status
    </select>

    <!-- èŽ·å–å½“æ—¥é¢„è®¢å‚è€ƒå·çš„æœ€å¤§åºå· -->
    <select id="getMaxSequenceByDatePrefix" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT MAX(CAST(RIGHT(booking_reference, 3) AS UNSIGNED)) as maxSeq
        FROM ticket_bookings 
        WHERE booking_reference LIKE CONCAT(#{datePrefix}, '%')
    </select>

    <!-- æ ¹æ®ç¥¨åŠ¡ä¸“å‘˜æŸ¥è¯¢é¢„è®¢ -->
    <select id="getByTicketSpecialist" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ticket_bookings 
        WHERE ticket_specialist = #{ticketSpecialist}
        <if test="bookingStatus != null and bookingStatus != ''">
            AND booking_status = #{bookingStatus}
        </if>
        ORDER BY visit_date DESC, created_at DESC
    </select>

    <!-- æ ¹æ®æ—…æ¸¸è®¢å•IDæŸ¥è¯¢ç¥¨åŠ¡é¢„è®¢è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ™¯ç‚¹ä¿¡æ¯ï¼‰ -->
    <!-- ðŸ†• æ”¯æŒæ‰¹é‡è®¢ç¥¨ï¼šåŒæ—¶æŸ¥è¯¢ tour_booking_id å’Œ related_order_ids -->
    <select id="getByTourBookingIdWithDetails" resultType="com.sky.vo.TicketBookingVO">
        SELECT 
            tb.id,
            tb.booking_reference as bookingReference,
            tb.confirmation_number as confirmationNumber,
            tb.schedule_order_id as scheduleOrderId,
            tb.tour_booking_id as tourBookingId,
            tb.attraction_id as attractionId,
            a.attraction_name as attractionName,
            a.attraction_name_en as attractionNameEn,
            tb.ticket_type_id as ticketTypeId,
            tt.ticket_type as ticketTypeName,
            tb.guest_name as guestName,
            tb.guest_phone as guestPhone,
            tb.guest_email as guestEmail,
            tb.visit_date as visitDate,
            tb.booking_date as bookingDate,
            tb.adult_count as adultCount,
            tb.child_count as childCount,
            tb.total_guests as totalGuests,
            tb.ticket_price as ticketPrice,
            tb.total_amount as totalAmount,
            tb.currency,
            tb.booking_method as bookingMethod,
            tb.booking_status as bookingStatus,
            tb.payment_status as paymentStatus,
            tb.special_requirements as specialRequirements,
            tb.ticket_specialist as ticketSpecialist,
            tb.confirmed_time as confirmedTime,
            tb.created_at as createdAt,
            tb.updated_at as updatedAt
        FROM ticket_bookings tb
        LEFT JOIN attractions a ON tb.attraction_id = a.id
        LEFT JOIN ticket_types tt ON tb.ticket_type_id = tt.id
        WHERE tb.tour_booking_id = #{tourBookingId}
           OR (tb.related_order_ids IS NOT NULL 
               AND JSON_CONTAINS(tb.related_order_ids, CAST(#{tourBookingId} AS JSON), '$'))
        ORDER BY tb.visit_date ASC, tb.created_at ASC
    </select>

</mapper>
