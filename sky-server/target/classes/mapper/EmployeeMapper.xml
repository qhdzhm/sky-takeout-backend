<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!-- EmployeeMapper.xml -->
<mapper namespace="com.sky.mapper.EmployeeMapper">

    <!-- 定义包含车辆信息的 ResultMap -->
    <resultMap id="EmployeeWithVehicleResultMap" type="com.sky.entity.Employee">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="sex" column="sex"/>
        <result property="idNumber" column="id_number"/>
        <result property="status" column="status"/>
        <result property="role" column="role"/>
        <result property="workStatus" column="work_status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createUser" column="create_user"/>
        <result property="updateUser" column="update_user"/>

        <!-- 关联车辆信息 -->
        <association property="assignedVehicle" javaType="com.sky.entity.Vehicle">
            <id property="vehicleId" column="vehicle_id"/>
            <result property="licensePlate" column="license_plate"/>
            <result property="vehicleType" column="vehicle_type"/>
            <result property="seatCount" column="seat_count"/>
            <!-- 其他车辆字段按需添加 -->
        </association>
    </resultMap>

    <!-- 分页查询（包含车辆信息） -->
    <select id="pageQuery" resultMap="EmployeeWithVehicleResultMap">
        SELECT
        e.*,
        v.vehicle_id,
        v.license_plate,
        v.vehicle_type,
        v.seat_count
        FROM
        employees e
        LEFT JOIN
        vehicle_driver vd ON e.id = vd.employee_id
        LEFT JOIN
        vehicles v ON vd.vehicle_id = v.vehicle_id

        <where>
            <if test="name != null and name != ''">
                AND e.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="role != null">
                AND e.role = #{role}
            </if>
            <if test="status != null">
                AND e.status = #{status}
            </if>
            <if test="licensePlate != null and licensePlate != ''">
                AND v.license_plate = #{licensePlate}
            </if>
            <if test="workStatus != null">
                AND e.work_status = #{workStatus}
            </if>
        </where>


        ORDER BY e.id DESC
    </select>
    <update id="status">
        UPDATE employees
        SET status = #{status}
        WHERE id = #{id}
    </update>
<!-- 插入员工数据 -->
<insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO employees
    (username, name, password, phone, sex, id_number, status, role, work_status, create_time, update_time, create_user, update_user)
    VALUES
    (#{username}, #{name}, #{password}, #{phone}, #{sex}, #{idNumber}, #{status}, #{role}, #{workStatus}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser})
</insert>
</mapper>